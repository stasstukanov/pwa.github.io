var videoSwipers = null;
var currentVideoSlider = null;
var currentLiveIcon = null;
var currentConnectingIcon = null;
var viewPerStory = {};
var loadedVideos = [];
var newStory = false;
var nbVideosSeen = 0;
var previousVideo = null;
var nbViewedVideos = 0;
var currentStoryIndex = null;
var currentStoryRedirectUrl = null;
var nbVideoLoaded = 0;
const videoToLoad = 7;
const maxVideo = 10;
const instacamgirlsRegisterUrl =
  "https://instacamgirlslive.com/signup/register";

const CATEGORIE_VIDEO_MAPPING = {
  default: {
	boomerangs: {
	  main: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/latina/Instacam+Boomerang+latina+02.mp4",
	  main_video:
		"https://instacamgirls-videos.s3.amazonaws.com/boomerang/latina/main/Main+latina+02.mp4",
	  others: {
		1: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/latina/Instacam+Boomerang+latina+07.mp4",
		2: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/latina/Instacam+Boomerang+latina+03.mp4",
		3: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/latina/Instacam+Boomerang+latina+04.mp4",
		4: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/latina/Instacam+Boomerang+latina+05.mp4",
		5: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/latina/Instacam+Boomerang+latina+06.mp4",
		6: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/latina/Instacam+Boomerang+latina+01.mp4",
	  },
	  others_videos: {
		1: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/latina/main/Main+latina+07.mp4",
		2: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/latina/main/Main+latina+03.mp4",
		3: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/latina/main/Main+latina+04.mp4",
		4: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/latina/main/Main+latina+05.mp4",
		5: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/latina/main/Main+latina+06.mp4",
		6: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/latina/main/Main+latina+01.mp4",
	  },
	},
  },
  blonde: {
	boomerangs: {
	  main: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/blonde/Boomerang11.mp4",
	  main_video:
		"https://instacamgirls-videos.s3.amazonaws.com/boomerang/blonde/main/Blonde11.mp4",
	  others: {
		1: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/blonde/Boomerang12.mp4",
		2: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/blonde/Boomerang07.mp4",
		3: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/blonde/Boomerang09.mp4",
		4: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/blonde/Boomerang04.mp4",
		5: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/blonde/Boomerang03.mp4",
		6: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/blonde/Boomerang10.mp4",
	  },
	  others_videos: {
		1: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/blonde/main/Blonde12.mp4",
		2: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/blonde/main/Blonde07.mp4",
		3: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/blonde/main/Blonde09.mp4",
		4: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/blonde/main/Blonde15.mp4",
		5: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/blonde/main/Blonde03.mp4",
		6: "https://instacamgirls-videos.s3.amazonaws.com/boomerang/blonde/main/Blonde10.mp4",
	  },
	},
  },
  brunette: {
	boomerangs: {
	  main: "",
	  others: [],
	},
  },
  redhead: {
	boomerangs: {
	  main: "",
	  others: [],
	},
  },
  asian: {
	boomerangs: {
	  main: "",
	  others: [],
	},
  },
  black: {
	boomerangs: {
	  main: "",
	  others: [],
	},
  },
};

function $_GET(key) {
  var s = decodeURIComponent(window.location.search);
  s = s.match(new RegExp(key + "=([^&=]+)"));
  return s ? s[1] : false;
}

function addListinerForHeader() {
  document.addEventListener(
	"scroll",
	function () {
	  var vapp = document.getElementsByClassName("v-application")[0];
	  var header = document.getElementsByClassName("Header")[0];
	  var clientBound = vapp.getBoundingClientRect();

	  if (clientBound.y < -64) {
		header.classList.remove("transparent");
		header.classList.add("Header--scrolled");
	  } else {
		header.classList.add("transparent");
		header.classList.remove("Header--scrolled");
	  }
	},
	{
	  passive: true,
	}
  );
}

function fadeOut(el) {
  el.style.opacity = 1;
  (function fade() {
	if ((el.style.opacity -= 0.1) < 0) {
	  el.style.display = "none";
	} else {
	  requestAnimationFrame(fade);
	}
  })();
}

function hideSplash() {
  var splash = document.getElementsByClassName("bs-splash")[0];
  fadeOut(splash);
}

function initVideoSlider() {
  videoSwipers = new Swiper(".swiper-container", {
	pagination: {
	  el: ".swiper-pagination",
	},
	navigation: {},
  });

  videoSwipers = Array.prototype.slice.apply(videoSwipers);
  videoSwipers.forEach(function (videoSwiper, videoSliderIndex) {
	videoSwiper.on("slideChange", function () {
	  increaseViewedStories(videoSliderIndex);
	  restartAndPlayVideo(videoSliderIndex);
	});

	videoSwiper.slides.forEach(function (slide, index) {
	  slide.children[0].addEventListener("ended", function () {
		if (index + 1 >= videoSwiper.slides.length) {
		  increaseViewedStories(videoSliderIndex);
		} else {
		  videoSwiper.slideTo(videoSwiper.realIndex + 1);
		  restartAndPlayVideo(videoSliderIndex);
		}
	  });
	});
  });
}

function needToBlockAndRedirectUser() {
  var nbViewedStory = 0;
  videoSwipers.forEach(function (slider, index) {
	if (viewPerStory[index] == slider.slides.length) {
	  nbViewedStory = nbViewedStory + 1;
	}
  });
  return (
	nbViewedVideos >= maxVideo ||
	nbViewedStory >= 7 ||
	Cookies.get("user-blocked")
  );
}

function increaseViewedStories(index) {
  nbViewedVideos = nbViewedVideos + 1;
  viewPerStory[index] = viewPerStory[index] ? viewPerStory[index] + 1 : 1;
  if (needToBlockAndRedirectUser()) {
	Cookies.set("user-blocked", "true");
	window.location.href = currentStoryRedirectUrl;
  }
}

function toggleVideoSlider(open, storyIndex, storyRedirectUrl) {
  currentStoryIndex = storyIndex;
  currentStoryRedirectUrl = storyRedirectUrl;
  if (Cookies.get("user-blocked")) {
	window.location.href = currentStoryRedirectUrl;
  } else {
	document.getElementById("video-slider-" + storyIndex).style.visibility =
	  open ? "visible" : "hidden";

	if (open) {
	  restartAndPlayVideo(storyIndex - 1);
	}
  }
}

function restartAndPlayVideo(index) {
  var currentSlider = videoSwipers[index];
  var currentSlide = currentSlider.slides[currentSlider.realIndex];
  var overlay = currentSlide.querySelector(".video-overlay");
  var currentVideo = currentSlide.querySelector("video");
  currentConnectingIcon = currentSlide.querySelector(".connection-icon");
  currentLiveIcon = currentSlide.querySelector(".live-icon");

  if (loadedVideos.includes(currentVideo.src)) {
	currentConnectingIcon.style.display = "block";
	currentLiveIcon.style.visibility = "visible";
	overlay.style.display = "flex";
  } else {
	currentConnectingIcon.style.display = "block";
	currentLiveIcon.style.visibility = "hidden";
	currentVideo.curcurrentTime = 0;
	currentVideo.load();
	currentVideo.onloadeddata = function () {
	  setTimeout(function () {
		currentConnectingIcon.style.display = "none";
		currentLiveIcon.style.visibility = "visible";
		if (hasSeenVideo(currentVideo.src)) {
		  overlay.style.display = "flex";
		} else {
		  currentVideo.play();
		  loadedVideos.push(currentVideo.src);
		  setViewedVideo(currentVideo.src);
		}
	  }, 1500);
	};
	currentVideo.addEventListener("ended", function () {
	  overlay.style.display = "flex";
	  nbVideosSeen = nbVideosSeen + 1;
	  setViewedVideo(currentVideo.src);
	});
  }

  previousVideo = currentVideo;
}

function hasSeenVideo(url) {
  var seenVideos = Cookies.get("seen-videos");
  if (seenVideos) {
	seenVideos = JSON.parse(seenVideos);
	return seenVideos.includes(url);
  }
  return false;
}

function setViewedVideo(url) {
  var seenVideos = Cookies.get("seen-videos");
  if (seenVideos) {
	seenVideos = JSON.parse(seenVideos);
	seenVideos.push(url);
	Cookies.set("seen-videos", JSON.stringify(seenVideos));
  } else {
	Cookies.set("seen-videos", JSON.stringify([url]));
  }
}

function handlePlayButtons() {
  var playButtons = [];
  playButtons = Array.prototype.concat.apply(
	playButtons,
	document.getElementsByClassName("ExpoPlayer__media__video")
  );
  playButtons = Array.prototype.concat.apply(
	playButtons,
	document.getElementsByClassName("ExpoPlayer__media__video_cam")
  );
  for (let i = 0; i < playButtons.length; i++) {
	playButtons[i].addEventListener("click", function () {
	  toggleVideoSlider(
		true,
		this.getAttribute("data-story-index"),
		this.getAttribute("data-story-redirect-url")
	  );
	});
  }
}

function closeVideoSlider(index) {
  currentConnectingIcon.style.display = "none";
  currentLiveIcon.style.visibility = "hidden";

  if (previousVideo) {
	previousVideo.pause();
  }
  document.getElementById("video-slider-" + index).style.visibility = "hidden";
  var liveIcons = document.getElementsByClassName("live-icon");
  for (let i = 0; i < liveIcons.length; i++) {
	liveIcons[i].style.visibility = "hidden";
  }
}

function showRandomBoomerang(
  attributeName,
  totalToShow,
  videoAttribute,
  isCover
) {
  var shownBoomerangIndexList = [];
  var max = document.querySelectorAll("[" + attributeName + "]").length + 1;
  var min = 1;

  while (shownBoomerangIndexList.length < totalToShow) {
	var boomerangToShow = getRandomIndexBetween(min, max);
	while (shownBoomerangIndexList.includes(boomerangToShow)) {
	  boomerangToShow = getRandomIndexBetween(min, max);
	}
	shownBoomerangIndexList.push(boomerangToShow);
	var boomerang = document.querySelector(
	  ".ExpoPlayer[" + attributeName + "='" + boomerangToShow + "']"
	);
	boomerang.style.display = "block";

	if (videoAttribute) {
	  var childVideo = document.querySelector(
		".ExpoPlayer__media__video[" +
		  videoAttribute +
		  "='" +
		  boomerangToShow +
		  "']"
	  );
	  childVideo.removeAttribute("preload");
	  childVideo.setAttribute("autoplay", "autoplay");
	  childVideo.setAttribute("src", childVideo.getAttribute("data-src"));

	  childVideo.addEventListener("loadeddata", function () {
		nbVideoLoaded = nbVideoLoaded + 1;
		if (nbVideoLoaded == videoToLoad) {
		  hideSplash();
		}
	  });
	}
  }
}

function getRandomIndexBetween(start, end) {
  return Math.floor(Math.random() * (end - start)) + start;
}

function updateRegisterRedirectUrl() {
  const { searchParams: locationSearchParams } = new URL(window.location.href);
  var signBtns = document.getElementsByClassName("signup-btn");
  var cidValue = $_GET("cid");
  var redirectUrl = instacamgirlsRegisterUrl;

  if (cidValue) {
	redirectUrl = redirectUrl + "?AFNO=1-1-" + cidValue;
  }

  for (let i = 0; i < signBtns.length; i++) {
	const parsedLink = new URL(redirectUrl);
	for (const [key, value] of locationSearchParams) {
	  parsedLink.searchParams.set(key, value);
	}
	signBtns[i].href = parsedLink.toString();
  }
}

function loadVideos() {
  var category = $_GET("category") || "default";
  var videos = CATEGORIE_VIDEO_MAPPING[category];

  document
	.querySelector("[data-cover-boomerang-video-index='1']")
	.setAttribute("data-src", videos.boomerangs.main);
  $("#video-slider-1").find("video").attr("src", videos.boomerangs.main_video);

  for (var i = 1; i < 7; i++) {
	document
	  .querySelector("[data-small-boomerang-video-index='" + i + "']")
	  .setAttribute("data-src", videos.boomerangs.others[i]);
	$("#video-slider-" + (i + 1))
	  .find("video")
	  .attr("src", videos.boomerangs.others_videos[i]);
  }
}

document.addEventListener("DOMContentLoaded", function () {
  loadVideos();

  document.body.addEventListener(
	"touchstart",
	function () {
	  var allVideos = document.querySelectorAll(".ExpoPlayer__media__video");
	  for (var i = 0; i < allVideos.length; i++) {
		allVideos[i].play();
	  }
	},
	{ once: true }
  );

  updateRegisterRedirectUrl();
  addListinerForHeader();
  initVideoSlider();
  handlePlayButtons();
  showRandomBoomerang(
	"data-cover-boomerang-index",
	1,
	"data-cover-boomerang-video-index",
	true
  );
  showRandomBoomerang(
	"data-small-boomerang-index",
	6,
	"data-small-boomerang-video-index",
	false
  );
});